# Plan: Main.py Modular Refactor

## Goal/Scope
- 将 `LyreAutoPlayer/main.py` 精简为核心功能入口，其他功能拆分为扩展模块或插件（含语言/i18n），确保重构后所有功能完整且无行为回归。

## Constraints/Assumptions
- 当前 `ops/ai/tasks/20260101-2137-octave-policy-feature/request.md` 与 `evidence/context_pack.md` 记录的是已完成的八度策略与 i18n 修复，本计划以“新增的重构需求”为准。
- 功能不丢失：播放、量化、输入、错误模拟、8-bar、UI 配置、快捷键、浮窗、i18n 等均需保留。
- 重构后仍应可直接运行 `LyreAutoPlayer/main.py`（或等效入口），不增加用户启动复杂度。
- 插件加载失败需可降级并提示，不应导致主程序崩溃。

## Plan Steps
1. 盘点 `main.py` 的功能模块与耦合点：UI 构建、播放线程、MIDI 解析、输入管理、错误模拟、8-bar、i18n、浮窗、快捷键等，形成模块边界清单。
2. 定义核心与插件边界：核心保留程序入口、配置模型、事件调度、插件加载与生命周期管理；其余拆分为独立模块/插件。
3. 设计插件接口（最小 API）：`register(app)`, `on_load()`, `on_unload()` 等，明确可访问的核心服务（日志、配置、事件总线、UI 钩子）。
4. 拆分 i18n：将翻译字典与语言切换逻辑下沉为 `i18n` 插件或模块，核心仅提供 `tr()` 接口和语言状态。
5. 拆分 UI：把各 Tab/面板构建逻辑移到独立模块（或 UI 插件），主窗体只负责容器与布局注册。
6. 拆分播放与输入：把播放线程、MIDI 解析、输入管理、错误模拟、8-bar 变体等拆成独立模块，并通过核心配置注入。
7. 迁移配置与状态：确保新模块读取/写回配置方式一致，老配置值保持兼容。
8. 回归验证：逐项核对原功能（播放、快捷键、浮窗、语言、错误模拟、音色、8-bar、诊断等）可用且行为一致。
9. 清理与文档：更新 README 或使用说明，标注插件目录结构与扩展方式。

## Acceptance Checklist
- [ ] `main.py` 只保留核心入口与插件加载逻辑，体积显著缩小。
- [ ] i18n 独立为模块/插件，语言切换与 `tr()` 功能正常。
- [ ] UI 各 tab/面板已拆分为模块或插件，功能与布局不变。
- [ ] 播放、输入、错误模拟、8-bar 等功能按模块拆分后可正常工作。
- [ ] 配置兼容性保持，旧配置无需迁移即可运行。
- [ ] 插件加载失败可降级并提示，主程序稳定运行。
- [ ] 手动验证覆盖主要功能入口与关键操作。

## Risks/Dependencies
- 拆分过程中跨模块引用较多，需避免循环依赖。
- 插件接口设计不当可能导致后续扩展困难或破坏现有调用路径。
