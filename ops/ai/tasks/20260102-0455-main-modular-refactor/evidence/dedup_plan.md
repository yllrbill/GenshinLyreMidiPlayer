# Dedup Plan (重复功能排查与合并)

## 目标
识别并合并 `LyreAutoPlayer/main.py` 内重复逻辑，减少体积与维护成本，保证行为不变。

## 判定规则
- 同类 UI 构建流程重复 >= 2 处
- 相似参数校验/默认值处理重复 >= 2 处
- 时间/节拍/速度计算重复 >= 2 处
- i18n 文案绑定重复 >= 2 处
- 日志/提示语拼接重复 >= 2 处

## 排查清单

### 1. UI 构建流程重复 (≥2 处)

| 重复模式 | 位置 | 出现次数 | 建议合并 |
|----------|------|----------|----------|
| QComboBox 创建 + addItem/addItems | L1460-1476, L1778-1905, L2003-2175 | 15+ 处 | 提炼 `create_combo(items, data)` 工厂函数 |
| QSpinBox/QDoubleSpinBox 创建 + setRange + setValue | L1824-1911, L2087-2322 | 18 处 | 提炼 `create_spinbox(range, default)` 工厂函数 |
| QLabel(tr(...)) + ":" 后缀 | L1421-1488, L2266-2314 | 9 处 | 提炼 `create_label(tr_key, suffix=":")` |
| QCheckBox(tr(...)) 创建 | L2289-2292 | 4 处 | 同一区域可合并为循环 |
| 预设下拉框 (21-key/36-key) | L1852-1853, L2004-2005 | 2 处 | 抽取常量 `PRESET_ITEMS` |

### 2. 参数校验/默认值处理重复 (≥2 处)

| 重复模式 | 位置 | 出现次数 | 建议合并 |
|----------|------|----------|----------|
| setValue 初始化默认值 | L1836-1911 (首次), L2869-2887 (重置) | 2 处 | 提炼 `reset_defaults()` 或配置驱动 |
| setValue 从 settings 加载 | L2943-2995, L3580-3680 | 2 处 | 统一为 `load_settings_to_ui()` |
| sp_XXX_min/max 成对设置 | L2179-2228 (8-bar), L2315-2322 (pause) | 4 对 | 提炼 `create_range_spinboxes(min_range, max_range)` |

### 3. 时间/节拍/速度计算重复 (≥2 处)

| 重复模式 | 位置 | 出现次数 | 建议合并 |
|----------|------|----------|----------|
| 默认 tempo=500000 / 120 BPM | L318, L427, L750 | 3 处 | 抽取常量 `DEFAULT_TEMPO_US`, `DEFAULT_BPM` |
| 默认 beat_duration=0.5 | L729, L745, L751 | 3 处 | 抽取常量 `DEFAULT_BEAT_DURATION` |
| 默认 bar_duration=2.0 | L521, L750, L1111 | 3 处 | 抽取常量 `DEFAULT_BAR_DURATION` |
| segment_duration = bar * 8 | L744, L760, L1112 | 3 处 | 已有函数可复用 |
| calculate_bar_and_beat_duration 调用 | L733, L755 | 2 处 | PlayerThread 内可复用结果 |

### 4. i18n 文案绑定重复 (≥2 处)

| 重复模式 | 位置 | 出现次数 | 建议合并 |
|----------|------|----------|----------|
| tr() 调用 | 全文件 | 135 处 | 已抽取到 i18n 模块，无需进一步合并 |
| cmb.setItemText + tr() 批量更新 | L2447-2461 | 8 处 | 可提炼 `update_combo_i18n(cmb, keys)` |
| lbl.setText(tr(...)) 批量更新 | L2408-2482 | 30+ 处 | 可提炼 `update_labels_i18n(mapping)` |

### 5. 日志/提示语拼接重复 (≥2 处)

| 重复模式 | 位置 | 出现次数 | 建议合并 |
|----------|------|----------|----------|
| self.log.emit(f"...") | PlayerThread L538-1331 | 50+ 处 | 结构一致，无需合并 |
| self.append_log(f"...") | MainWindow L2611-2635 | 10+ 处 | 结构一致，无需合并 |
| f"8-Bar ..." 日志前缀 | L756-799, L1119, L3209 | 5 处 | 可提炼 `log_8bar(msg)` |
| f"[Error] ..." 日志前缀 | L1215-1238 | 4 处 | 可提炼 `log_error(type, time)` |
| f"Sound: ..." 日志前缀 | L607-669 | 10 处 | 可提炼 `log_sound(msg)` |
| f"[Input] ..." 日志前缀 | L1309-1324 | 5 处 | 可提炼 `log_input(msg)` |

## 合并策略
- 提炼公共函数或基类，避免复制粘贴逻辑
- UI 用"配置驱动生成"或统一 builder
- 计算逻辑放入 `utils` 或 `core` 服务
- 纯重构：不改变行为与对外接口

## 合并优先级

| 优先级 | 模式 | 预计减少行数 | 风险 | 建议 |
|--------|------|-------------|------|------|
| **P1** | 时间常量抽取 (tempo/beat/bar) | ~20 行 | 低 | 立即执行 |
| **P1** | 预设下拉框常量 | ~5 行 | 低 | 立即执行 |
| **P2** | UI 工厂函数 (spinbox/combo/label) | ~100 行 | 中 | 需测试 UI 行为 |
| **P2** | setValue 加载/重置统一 | ~50 行 | 中 | 需验证配置兼容性 |
| **P3** | i18n 批量更新函数 | ~30 行 | 低 | 可选优化 |
| **P3** | 日志前缀函数 | ~10 行 | 低 | 可选优化 |

**总计预估**：可减少 ~200-250 行重复代码

## 风险
- 过度抽象导致逻辑隐藏、调试困难
- 误合并造成行为回归
- UI 工厂函数可能影响控件样式/信号连接

## 验收
- [x] 重复点清单完整且可追溯（指向具体位置）
- [ ] 合并后功能行为一致，语法检查通过
- [ ] 手动验证 UI 布局与交互无变化

---
*Updated: 2026-01-02*
*Step 2 完成: 重复功能排查*
