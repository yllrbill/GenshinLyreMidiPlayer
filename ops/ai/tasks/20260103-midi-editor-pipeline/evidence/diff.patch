diff --git a/.claude/settings.local.json b/.claude/settings.local.json
index 61ab99b..8f7cf5d 100644
--- a/.claude/settings.local.json
+++ b/.claude/settings.local.json
@@ -8,7 +8,9 @@
       "Skill(ai-intake)",
       "Skill(ai-intake:*)",
       "Skill(repo-push)",
-      "Skill(repo-push:*)"
+      "Skill(repo-push:*)",
+      "Skill(repo-audit)",
+      "Skill(repo-audit:*)"
     ]
   },
   "enableAllProjectMcpServers": true,
diff --git a/LyreAutoPlayer/i18n/translations.py b/LyreAutoPlayer/i18n/translations.py
index 95af1b4..caa7c66 100644
--- a/LyreAutoPlayer/i18n/translations.py
+++ b/LyreAutoPlayer/i18n/translations.py
@@ -205,6 +205,11 @@ TRANSLATIONS = {
         LANG_EN: "Forces mechanical input, speed=1.0, MIDI duration, disables errors/8-bar",
         LANG_ZH: "强制机械输入、速度=1.0、使用MIDI时值，禁用失误/8小节风格",
     },
+    "strict_midi_timing": {LANG_EN: "Strict MIDI Timing", LANG_ZH: "严格 MIDI 时序"},
+    "strict_midi_timing_hint": {
+        LANG_EN: "Disable humanization (timing offset/stagger/duration variation) while keeping speed settings",
+        LANG_ZH: "禁用人性化抖动（时序偏移/分解/时值变化），保留速度设置",
+    },
     "pause_every_bars": {LANG_EN: "Auto Pause", LANG_ZH: "自动暂停"},
     "auto_resume_countdown": {LANG_EN: "Resume Countdown", LANG_ZH: "恢复倒计时"},
     "press_f5_continue": {LANG_EN: "Press F5 to continue", LANG_ZH: "按 F5 继续"},
diff --git a/LyreAutoPlayer/main.py b/LyreAutoPlayer/main.py
index 0f1502b..a6c1692 100644
--- a/LyreAutoPlayer/main.py
+++ b/LyreAutoPlayer/main.py
@@ -183,6 +183,7 @@ class MainWindow(
         self.editor_window: Optional[EditorWindow] = None
         self._current_input_style = "mechanical"
         self._strict_mode = True  # Strict mode default ON
+        self._strict_midi_timing = True  # Strict MIDI timing default ON
 
         # Playback progress tracking (for floating controller)
         self.current_time: float = 0.0
@@ -197,6 +198,8 @@ class MainWindow(
         # Apply initial strict mode state (disables controls when ON)
         if self._strict_mode and hasattr(self, 'chk_strict_mode'):
             self._on_strict_mode_changed(Qt.CheckState.Checked.value)
+        if self._strict_midi_timing and hasattr(self, 'chk_strict_midi_timing'):
+            self._on_strict_midi_timing_changed(Qt.CheckState.Checked.value)
 
     def init_ui(self):
         self.resize(950, 680)
@@ -362,6 +365,8 @@ class MainWindow(
         self.grp_strict_mode.setTitle(tr("strict_mode_group", self.lang))
         self.lbl_strict_mode.setText(tr("strict_mode", self.lang))
         self.chk_strict_mode.setToolTip(tr("strict_mode_hint", self.lang))
+        self.lbl_strict_midi_timing.setText(tr("strict_midi_timing", self.lang))
+        self.chk_strict_midi_timing.setToolTip(tr("strict_midi_timing_hint", self.lang))
         self.lbl_pause_bars.setText(tr("pause_every_bars", self.lang))
         self.lbl_auto_resume_countdown.setText(tr("auto_resume_countdown", self.lang))
         # Sync diagnostics window language if open
@@ -725,13 +730,30 @@ class MainWindow(
 
         # Disable controls that strict mode overrides (only remaining widgets)
         self.sp_speed.setEnabled(not enabled)
-        self.chk_midi_duration.setEnabled(not enabled)
+        if enabled:
+            self.chk_midi_duration.setChecked(True)
+            self.chk_midi_duration.setEnabled(False)
+        else:
+            self.chk_midi_duration.setEnabled(not self._strict_midi_timing)
 
         # Log state change
         self.append_log(f"Strict mode: {'ON' if enabled else 'OFF'}")
         if enabled:
             self.append_log("  → Speed=1.0, Duration=ON")
 
+    def _on_strict_midi_timing_changed(self, state: int):
+        """Toggle strict MIDI timing on/off (disable humanization only)."""
+        enabled = state == Qt.CheckState.Checked.value
+        self._strict_midi_timing = enabled
+        self.append_log(f"Strict MIDI timing: {'ON' if enabled else 'OFF'}")
+        if enabled:
+            self.chk_midi_duration.setChecked(True)
+            if not self._strict_mode:
+                self.chk_midi_duration.setEnabled(False)
+        else:
+            if not self._strict_mode:
+                self.chk_midi_duration.setEnabled(True)
+
     def closeEvent(self, event):
         """Cleanup global hotkeys on window close."""
         # Save settings before closing
diff --git a/LyreAutoPlayer/midi-change/index.json b/LyreAutoPlayer/midi-change/index.json
index 9c8dfc9..9626b28 100644
--- a/LyreAutoPlayer/midi-change/index.json
+++ b/LyreAutoPlayer/midi-change/index.json
@@ -98,6 +98,15 @@
       "last_modified": "2026-01-06T03:39:39.009228",
       "source_file_size": 15587,
       "source_note_count": 1774
+    },
+    {
+      "source_path": "d:\\dw11\\piano\\lyreautoplayer\\midi\\counting-stars-onerepublic.mid",
+      "saved_path": "d:\\dw11\\piano\\lyreautoplayer\\midi-change\\counting-stars-onerepublic_custom_custom.mid",
+      "display_name": "counting-stars-onerepublic_custom_custom",
+      "edit_style": "custom",
+      "last_modified": "2026-01-06T05:02:17.530042",
+      "source_file_size": 15587,
+      "source_note_count": 1774
     }
   ]
 }
\ No newline at end of file
diff --git a/LyreAutoPlayer/ops/ai/context/agents.md b/LyreAutoPlayer/ops/ai/context/agents.md
index 1d281f5..d6d14d2 100644
--- a/LyreAutoPlayer/ops/ai/context/agents.md
+++ b/LyreAutoPlayer/ops/ai/context/agents.md
@@ -24,6 +24,15 @@
 - Repro MIDI: `D:\dw11\piano\LyreAutoPlayer\midi\Counting-Stars-OneRepublic.mid`（截图红框附近：bar 17-18 / 约 0:34s）。
 - Audio mismatch: EditorWindow Play 的预览音色与主界面开始（F5）播放的音色不同，需要统一（同 SoundFont/同乐器/同力度策略）。
 - New issue: with very dense simultaneous notes (big chords), enabling `cfg.play_sound` (FluidSynth) can coincide with some keys not being output (notes are in-range).
+- Implemented (audit): `player/thread.py` deferred synth calls after key injection + lag instrumentation/batching; `ui/editor/key_list_widget.py` 36-key 高->低排序；`ui/editor/editor_window.py` 预览音色对齐主界面设置。
+- Verification (audit): `python -m py_compile` for modified files + import check passed.
+- User retest: dense section still piles up into next bar, but earlier red-box section improved.
+- User retest: batch press made playback worse on dense chords + fast rhythm; still piles up to next bar, overall “更乱”.
+- New request: disable all “风格/变音”演奏（不使用 timing_offset/stagger/duration_variation），机械遵循 MIDI（允许谱面编辑修改），考虑重构输出引擎。
+- Plan agreed: rollback batch press, add strict MIDI timing option (no humanization, keep speed), and remove chord-lock global delay.
+- Implemented (current): batch press reverted; strict MIDI timing flag + UI; chord-lock global delay disabled under strict MIDI timing.
+- New request: explain all configs affecting key press/release timing (input jitter, style/humanization, pause, etc.) before changes.
+- Hard constraints: keep MIDI editor full functionality, key injection strictly follows MIDI timing, preview should not affect key delay (excluding user edits).
 - Suspects:
   - Playback loop in `player/thread.py:_run_playback_loop` processes dense same-timestamp events serially; if processing + `time.sleep` overshoots, events become late and “pile up”.
   - Per-event overhead: `_input_manager.press/release` (SendInput) + optional `fs.noteon/noteoff` interleaving; audio work may push timing over budget.
@@ -33,6 +42,11 @@
 ## Open Questions
 - 现象是否只在 `play_sound=True` 时显著复现？（用于判断是否必须把音频链路完全移出关键路径）
 - 开启 `cfg.enable_diagnostics` 后，`[Input] Failed`/latency 分布是否出现尖峰？（用于判断是否存在 SendInput 调用失败或严重延迟）
+- 手动测试 Counting-Stars bar 17-18 是否仍有“积攒到下一小节”？
+- 如果仍有积攒：考虑批量 release 或在 lag 状态跳过本地音频。
+- 是否接受“延迟超阈值就丢弃过期事件”（避免堆积到下一小节）？
+- 是否需要新增独立的“严格 MIDI”模式（不影响速度/其他设置，只禁用风格/变音）？
+- 是否接受“迟到阈值丢弃”作为下一步防积攒策略？
 
 ## User Prompt
 Main Goal:
@@ -47,6 +61,9 @@ Phase Steps:
 3. Keep evidence references for tests.log, Stretch reset, and clip=True call sites.
 4. Diagnose and address missed output under dense chords when `play_sound=True`.
 5. Reorder KeyList rows for 36-key and align preview sound behavior.
+6. Validate with Counting-Stars bar 17-18 and confirm key injection timing.
+7. If lag persists, add batch release or audio skip-on-lag.
+8. If still failing, redesign output engine (batch SendInput for down/up in order + late-drop policy).
 
 Step Details (where to change, change summary):
 1. Where to change: D:\dw11\piano\LyreAutoPlayer\ui\editor\editor_window.py
@@ -69,6 +86,14 @@ Step Details (where to change, change summary):
    Change summary: Reorder 36-key rows from high pitch to low pitch.
 10. Where to change: D:\dw11\piano\LyreAutoPlayer\ui\editor\editor_window.py
    Change summary: Unify preview sound (SoundFont/instrument/velocity) with main playback settings.
+11. Where to change: D:\dw11\piano\LyreAutoPlayer\midi\Counting-Stars-OneRepublic.mid
+   Change summary: Use as manual repro/validation target.
+12. Where to change: D:\dw11\piano\LyreAutoPlayer\input_manager.py
+   Change summary: Batch SendInput press path to reduce per-key injection overhead.
+13. Where to change: D:\dw11\piano\LyreAutoPlayer\player/thread.py
+   Change summary: Optionally disable chord-lock delay, add late-drop policy, and/or batch down/up in one SendInput call.
+14. Where to change: D:\dw11\piano\LyreAutoPlayer\player/config.py
+   Change summary: Add “strict MIDI timing” flag to disable style variation without forcing speed/other strict-mode changes.
 
 Constraints:
 - Do not convert time_signature denominator to exponent; use the actual value.
diff --git a/LyreAutoPlayer/player/config.py b/LyreAutoPlayer/player/config.py
index 14aa8b0..bc2391e 100644
--- a/LyreAutoPlayer/player/config.py
+++ b/LyreAutoPlayer/player/config.py
@@ -48,6 +48,7 @@ class PlayerConfig:
 
     # Unified playback engine (统一播放引擎)
     strict_mode: bool = True              # 严格跟谱模式 (默认开启)
+    strict_midi_timing: bool = False      # 严格遵循 MIDI 时序（禁用风格演奏）
     pause_every_bars: int = 0             # 自动暂停间隔 (0=禁用, 1/2/4/8)
     auto_resume_countdown: int = 3        # 倒计时秒数
     bar_duration_override: float = 0.0    # 覆盖小节时长 (秒), 0=自动计算
diff --git a/LyreAutoPlayer/player/thread.py b/LyreAutoPlayer/player/thread.py
index 35afcbd..7374d61 100644
--- a/LyreAutoPlayer/player/thread.py
+++ b/LyreAutoPlayer/player/thread.py
@@ -418,7 +418,10 @@ class PlayerThread(QThread):
         post_release_s = 0.010  # 10ms
 
         # Get input style
-        style = INPUT_STYLES.get(self.cfg.input_style, INPUT_STYLES["mechanical"])
+        if self.cfg.strict_midi_timing:
+            style = INPUT_STYLES.get("mechanical", INPUT_STYLES["mechanical"])
+        else:
+            style = INPUT_STYLES.get(self.cfg.input_style, INPUT_STYLES["mechanical"])
         self.log.emit(f"Input style: {self.cfg.input_style}")
 
         notes_scheduled = 0
@@ -625,12 +628,13 @@ class PlayerThread(QThread):
 
             # Calculate unified delay (Chord-Lock Normalization)
             chord_delay = 0.0
-            for note_info in chord_processed:
-                delay_needed = note_info['next_free'] - note_info['desired_time']
-                if delay_needed > chord_delay:
-                    chord_delay = delay_needed
-            if chord_delay < 0:
-                chord_delay = 0.0
+            if not self.cfg.strict_midi_timing:
+                for note_info in chord_processed:
+                    delay_needed = note_info['next_free'] - note_info['desired_time']
+                    if delay_needed > chord_delay:
+                        chord_delay = delay_needed
+                if chord_delay < 0:
+                    chord_delay = 0.0
 
             # Schedule events (serialize same-key notes within the same chord)
             key_groups: Dict[str, List[dict]] = {}
diff --git a/LyreAutoPlayer/settings.json b/LyreAutoPlayer/settings.json
index d378944..5fd1a89 100644
--- a/LyreAutoPlayer/settings.json
+++ b/LyreAutoPlayer/settings.json
@@ -19,7 +19,7 @@
   "input_style": "mechanical",
   "enable_diagnostics": false,
   "soundfont_path": "C:\\soundfonts\\FluidR3_GM.sf2",
-  "last_midi_path": "D:/dw11/piano/LyreAutoPlayer/midi/绯想天-东方绯想天BGM.mid",
+  "last_midi_path": "d:\\dw11\\piano\\lyreautoplayer\\midi-change\\counting-stars-onerepublic_custom.mid",
   "input_manager": {},
   "error_config": {
     "enabled": false,
@@ -48,6 +48,7 @@
   },
   "strict_mode_config": {
     "enabled": true,
+    "strict_midi_timing": true,
     "pause_every_bars": 0,
     "auto_resume_countdown": 3
   },
diff --git a/LyreAutoPlayer/ui/mixins/config_mixin.py b/LyreAutoPlayer/ui/mixins/config_mixin.py
index 1b26d39..5f4d7c9 100644
--- a/LyreAutoPlayer/ui/mixins/config_mixin.py
+++ b/LyreAutoPlayer/ui/mixins/config_mixin.py
@@ -67,6 +67,11 @@ class ConfigMixin:
         if hasattr(self, 'sp_auto_resume_countdown'):
             auto_resume_countdown = self.sp_auto_resume_countdown.value()
 
+        # Strict MIDI timing (disable humanization without forcing speed=1.0)
+        strict_midi_timing = getattr(self, '_strict_midi_timing', False)
+        if hasattr(self, 'chk_strict_midi_timing'):
+            strict_midi_timing = self.chk_strict_midi_timing.isChecked()
+
         return PlayerConfig(
             root_mid_do=int(self.cmb_root.currentData()),
             octave_shift=int(self.cmb_octave.currentData()),
@@ -77,7 +82,7 @@ class ConfigMixin:
             octave_max_note=octave_max,
             octave_range_auto=self.chk_octave_range_auto.isChecked(),
             press_ms=int(self.sp_press.value()),
-            use_midi_duration=True if strict_mode else self.chk_midi_duration.isChecked(),
+            use_midi_duration=True if (strict_mode or strict_midi_timing) else self.chk_midi_duration.isChecked(),
             keyboard_preset=str(self.cmb_preset.currentData()),
             countdown_sec=int(self.sp_countdown.value()),
             target_hwnd=self.cmb_window.currentData(),
@@ -86,11 +91,12 @@ class ConfigMixin:
             soundfont_path=self.soundfont_path,
             instrument=str(self.cmb_instrument.currentText()),
             velocity=int(self.sp_velocity.value()),
-            input_style="mechanical" if strict_mode else self._current_input_style,
+            input_style="mechanical" if (strict_mode or strict_midi_timing) else self._current_input_style,
             error_config=error_cfg,
             enable_diagnostics=self._enable_diagnostics,
             eight_bar_style=eight_bar,
             strict_mode=strict_mode,
+            strict_midi_timing=strict_midi_timing,
             pause_every_bars=pause_every_bars,
             auto_resume_countdown=auto_resume_countdown,
         )
@@ -283,6 +289,9 @@ class ConfigMixin:
                 if "enabled" in smc and hasattr(self, 'chk_strict_mode'):
                     self.chk_strict_mode.setChecked(smc["enabled"])
                     self._strict_mode = smc["enabled"]
+                if "strict_midi_timing" in smc and hasattr(self, 'chk_strict_midi_timing'):
+                    self.chk_strict_midi_timing.setChecked(smc["strict_midi_timing"])
+                    self._strict_midi_timing = smc["strict_midi_timing"]
                 if "pause_every_bars" in smc and hasattr(self, 'cmb_pause_bars'):
                     pause_bars = smc["pause_every_bars"]
                     for i in range(self.cmb_pause_bars.count()):
diff --git a/LyreAutoPlayer/ui/mixins/playback_mixin.py b/LyreAutoPlayer/ui/mixins/playback_mixin.py
index d9bf7c2..243caf3 100644
--- a/LyreAutoPlayer/ui/mixins/playback_mixin.py
+++ b/LyreAutoPlayer/ui/mixins/playback_mixin.py
@@ -54,6 +54,9 @@ class PlaybackMixin:
             cfg.octave_shift = editor.get_octave_shift()
             cfg.input_style = editor.get_input_style()
 
+            if cfg.strict_mode or cfg.strict_midi_timing:
+                cfg.input_style = "mechanical"
+
         self.thread = PlayerThread(events_to_use, cfg)
         self.thread.log.connect(self.append_log)
         self.thread.finished.connect(self.on_finished)
diff --git a/LyreAutoPlayer/ui/mixins/settings_preset_mixin.py b/LyreAutoPlayer/ui/mixins/settings_preset_mixin.py
index 38b20e1..92ee34e 100644
--- a/LyreAutoPlayer/ui/mixins/settings_preset_mixin.py
+++ b/LyreAutoPlayer/ui/mixins/settings_preset_mixin.py
@@ -177,6 +177,7 @@ class SettingsPresetMixin:
             },
             "strict_mode_config": {
                 "enabled": hasattr(self, 'chk_strict_mode') and self.chk_strict_mode.isChecked(),
+                "strict_midi_timing": hasattr(self, 'chk_strict_midi_timing') and self.chk_strict_midi_timing.isChecked(),
                 "pause_every_bars": self.cmb_pause_bars.currentData() if hasattr(self, 'cmb_pause_bars') else 0,
                 "auto_resume_countdown": self.sp_auto_resume_countdown.value() if hasattr(self, 'sp_auto_resume_countdown') else 3,
             },
diff --git a/LyreAutoPlayer/ui/tab_builders.py b/LyreAutoPlayer/ui/tab_builders.py
index 1ec1197..9ee5f2e 100644
--- a/LyreAutoPlayer/ui/tab_builders.py
+++ b/LyreAutoPlayer/ui/tab_builders.py
@@ -173,6 +173,13 @@ def build_main_tab(window: "MainWindow") -> QWidget:
     window.lbl_strict_mode = QLabel()
     strict_form.addRow(window.lbl_strict_mode, window.chk_strict_mode)
 
+    # Strict MIDI timing checkbox (disable humanization, keep speed)
+    window.chk_strict_midi_timing = QCheckBox()
+    window.chk_strict_midi_timing.setChecked(True)
+    window.chk_strict_midi_timing.stateChanged.connect(window._on_strict_midi_timing_changed)
+    window.lbl_strict_midi_timing = QLabel()
+    strict_form.addRow(window.lbl_strict_midi_timing, window.chk_strict_midi_timing)
+
     # Auto-pause interval selector
     pause_row = QHBoxLayout()
     window.cmb_pause_bars = QComboBox()
diff --git a/ops/ai/state/STATE.md b/ops/ai/state/STATE.md
index 967a162..b30fc58 100644
--- a/ops/ai/state/STATE.md
+++ b/ops/ai/state/STATE.md
@@ -2,9 +2,9 @@
 
 ## Latest Task
 - TASK_ID: 20260103-midi-editor-pipeline
-- Status: PHASE DONE → NEW PHASE PENDING (Key Injection Performance)
+- Status: DRAFT - Session 16 uncommitted, pending Planner decision
 - Pointer: ops/ai/tasks/20260103-midi-editor-pipeline
-- Latest Commit: `2789fbe` (pending: Session 13-14 changes)
+- Latest Commit: `6b18283` (Session 15 committed, Session 16 uncommitted)
 
 ## Previous Task
 - TASK_ID: 20260102-2138-main-mixin-refactor
@@ -12,10 +12,10 @@
 - Pointer: ops/ai/tasks/20260102-2138-main-mixin-refactor
 
 ## Current Focus
+- Session 16: Batch SendInput press_many (UNCOMMITTED, user reported worsened dense sections)
+- Session 15: Key injection performance (COMMITTED 6b18283)
 - Session 14: time_signature denominator fix (VERIFIED 6/6 PASSED)
-- NEW PHASE: Key injection performance, KeyList reorder, preview sound unify
 - Session 13: BPM/tempo preservation fixes (审计发现的 6 个问题)
-- Session 12: Variable bar length system (可变小节时长)
 
 ## Completed Summary (MIDI Editor)
 - **Phase 1 钢琴卷帘骨架完成**: 6 个新文件 (~745 行)
@@ -64,6 +64,7 @@
 2. Phase 3-4: 高级编辑 + 超音域处理预览（如需继续）
 
 ## Recent Completions
+- **Key Injection Performance (Session 15, 2026-01-06) - Committed: 6b18283**
 - **time_signature denominator fix (Session 14, 2026-01-06) - VERIFIED 6/6**
 - Timeline/PianoRoll alignment fix (Session 13-14) - Committed: 2789fbe
 - Variable Bar Length System (Session 12, 2026-01-05) - Committed: 62f4743
@@ -92,11 +93,11 @@
 ---
 
 ## Next Actions
-1. **Decision**: Commit Session 13-14 changes before starting new phase?
-2. **New Phase Step 1**: Reproduce key injection issue with `midi/Counting-Stars-OneRepublic.mid` bar ~17-18
-3. **New Phase Step 2**: Add lag instrumentation in PlayerThread
-4. **New Phase Step 3**: Batch SendInput for same-timestamp events
-5. **New Phase Step 4**: Isolate FluidSynth audio from critical key injection path
+1. **Planner Decision**: Rollback press_many? Tune debounce? Add late-drop?
+2. **Document**: All timing-affecting configs (style/humanization, debounce, chord-lock)
+3. **Test**: Play Counting-Stars bar 17-18 with/without press_many
+4. **Consider**: Strict MIDI timing flag (disable humanization)
+5. **Validate**: Regressions (KeyList order, Editor/Main sound, bar_boundaries_sec)
 
 ---
-*Last Updated: 2026-01-06 (Session 14 - time_signature fix VERIFIED, NEW PHASE PENDING)*
+*Last Updated: 2026-01-06 (Session 16 - DRAFT, pending Planner decision)*
diff --git a/ops/ai/tasks/20260103-midi-editor-pipeline/evidence/context_pack.md b/ops/ai/tasks/20260103-midi-editor-pipeline/evidence/context_pack.md
index 2244a43..9a05d35 100644
--- a/ops/ai/tasks/20260103-midi-editor-pipeline/evidence/context_pack.md
+++ b/ops/ai/tasks/20260103-midi-editor-pipeline/evidence/context_pack.md
@@ -2,13 +2,32 @@
 
 ## Task
 - ID: 20260103-midi-editor-pipeline
-- Status: PHASE DONE → PENDING COMMIT
+- Status: DRAFT - Batch press_many uncommitted, pending user test
 - Last Updated: 2026-01-06
-- Latest Commit: `2789fbe` (uncommitted changes in progress)
+- Latest Commit: `6b18283` (Session 15 committed, Session 16 uncommitted)
 
 ---
 
-## Session 15 Summary (2026-01-06)
+## Session 16 Summary (2026-01-06)
+**Batch SendInput press_many - UNCOMMITTED**
+
+### Key Changes
+1. **`press_many()` method** - `input_manager.py:692-806` (+116 lines)
+   - Single `SendInput()` call for multiple keys
+   - Fallback to individual `press()` if batch fails
+2. **Batched key presses** - `thread.py:915,1043-1047`
+   - Collect `pending_presses[]` during event loop
+   - Execute via `press_many()` after releases
+
+### Decision Required
+User reported batch press **worsened** dense sections. Planner should decide:
+- **Rollback** press_many and keep deferred synth only?
+- **Adjust** chord-lock delay / debounce settings?
+- **Add** late-drop policy for overloaded batches?
+
+---
+
+## Session 15 Summary (2026-01-06) - Committed: 6b18283
 **Key Injection Performance Optimization - 7/7 COMPLETED**
 
 ### Key Changes
diff --git a/ops/ai/tasks/20260103-midi-editor-pipeline/evidence/diff.patch b/ops/ai/tasks/20260103-midi-editor-pipeline/evidence/diff.patch
index d129e5a..c9ead95 100644
--- a/ops/ai/tasks/20260103-midi-editor-pipeline/evidence/diff.patch
+++ b/ops/ai/tasks/20260103-midi-editor-pipeline/evidence/diff.patch
@@ -1,1039 +0,0 @@
-diff --git a/.codex/skills/planner/SKILL.md b/.codex/skills/planner/SKILL.md
-index a7afb4c..3907b83 100644
---- a/.codex/skills/planner/SKILL.md
-+++ b/.codex/skills/planner/SKILL.md
-@@ -1,15 +1,20 @@
- ---
- name: planner
--description: Create a task plan by reading ops/ai/state/STATE.md and the latest task's request.md + context_pack.md, then output plan.md and (when requested) patch.diff. Use when the user invokes $planner or asks to generate a plan from those three files.
-+description: Create a task plan from ops/ai/state/STATE.md and the latest task's request.md + context_pack.md, OR maintain ChatGPT/Claude prompt docs (agents.md + d:\dw11\piano\.claude\private\plan.md) from a chat transcript. Use when the user invokes $planner, asks to generate a plan, or asks to update agents.md/Claude plan from chat logs.
- ---
- 
- # Planner
- 
- ## Overview
- 
-+本技能支持两类工作流，按用户请求选择其一；不明确时先问一句确认。
-+
-+- **Workflow A**：基于 `ops/ai/state/STATE.md` 生成任务计划（原 planner 流程）
-+- **Workflow B**：维护 ChatGPT/Claude 持久提示词（`agents.md` + `d:\dw11\piano\.claude\private\plan.md`）
-+
- Generate a concise plan from ops/ai/state/STATE.md and the latest task's request.md + context_pack.md. Produce plan.md and, if requested or when changes were made, provide patch.diff containing the unified diff for plan.md.
- 
--## Workflow
-+## Workflow A - Task Plan (ops/ai)
- 
- ### Step 1: Locate TASK_ID (骨架感知)
- 
-@@ -99,3 +104,72 @@ When requested (or when explicitly asked to include it):
- | tasks 目录为空 | **STOP** - 提示运行 /ai-intake |
- | request.md 不存在 | **STOP** - fail-closed |
- | context_pack.md 不存在 | 降级读 handoff.md，或仅用 request.md |
-+
-+## Workflow B - 持久提示词维护 (ChatGPT/Claude)
-+
-+### 触发条件（任一满足即可）
-+- 用户提到 `agents.md` / ChatGPT 维持上下文 / Claude 提示词 / “基于聊天生成提示词”
-+- 用户明确要求生成或更新 `D:\dw11\piano\LyreAutoPlayer\ops\ai\context\agents.md` 或 `d:\dw11\piano\.claude\private\plan.md`
-+
-+### 关键约束
-+- 只在 `LyreAutoPlayer/ops/ai/context/agents.md` 内维护 ChatGPT 持久信息；**文件路径与文件名固定**，不要新建/改名该目录下的其它文件。
-+- `LyreAutoPlayer/ops/ai/context/PROJECT_SUMMARY.md` 只读不改。
-+- Claude 执行提示词**仅**写入 `d:\dw11\piano\.claude\private\plan.md`，不要写入其它 `plan.md` 位置或变体路径。
-+- 对话内容必须来自用户提供的聊天记录或明确指向的文件；缺失则先请求用户贴出。
-+
-+### 步骤
-+1. 读取 `LyreAutoPlayer/ops/ai/context/agents.md`（不存在则用模板创建）
-+2. 读取 `LyreAutoPlayer/ops/ai/context/PROJECT_SUMMARY.md`
-+3. 读取用户贴出的聊天记录（必需）；如未提供，先询问
-+4. 如聊天中引用仓库文件或模块，再按需读取相关文件（避免全仓库扫描）
-+5. 更新 `agents.md`：
-+   - 合并新增约束/关键背景/决定/待确认项
-+   - 保留已有内容，除非被明确推翻
-+   - 结构保持稳定，避免大改版
-+6. 生成 `d:\dw11\piano\.claude\private\plan.md`（Claude 专用提示词，唯一输出位置）
-+7. 回复用户时只做简要总结 + 列出更新文件路径，不贴整段内容
-+
-+### agents.md 模板（ChatGPT 专用）
-+```
-+# ChatGPT Context (固定文件)
-+
-+## 关键目标
-+- ...
-+
-+## 持久约束
-+- ...
-+
-+## 关键背景/决定
-+- ...
-+
-+## 待确认
-+- ...
-+
-+## 给用户的提示词
-+主要目标：
-+阶段步骤：
-+步骤内容（从哪改、改动代码摘要）：
-+约束：
-+```
-+
-+### d:\dw11\piano\.claude\private\plan.md 模板（Claude 专用）
-+```
-+# Claude Prompt
-+
-+## 主要目标
-+- 一句话目标（与用户请求一致）
-+- 完成标准/验收点（可验证）
-+
-+## 阶段步骤
-+1. 读取/确认输入（聊天记录 + context/必要文件）
-+2. 修改实现（按文件/模块分组）
-+3. 验证/输出（测试或人工验证点）
-+
-+## 步骤内容（从哪改、改动代码摘要）
-+1. 从哪改：<path or module>
-+   改动代码摘要：<改什么/为什么>
-+
-+## 约束
-+- 语言/路径/禁止事项（仅列相关）
-+- 若信息缺失，先向用户确认
-+```
-diff --git "a/LyreAutoPlayer/midi-change/Counting-Stars-C\350\260\203\347\256\200\345\215\225\347\211\210_custom.mid" "b/LyreAutoPlayer/midi-change/Counting-Stars-C\350\260\203\347\256\200\345\215\225\347\211\210_custom.mid"
-index 50850e2..51a663f 100644
-Binary files "a/LyreAutoPlayer/midi-change/Counting-Stars-C\350\260\203\347\256\200\345\215\225\347\211\210_custom.mid" and "b/LyreAutoPlayer/midi-change/Counting-Stars-C\350\260\203\347\256\200\345\215\225\347\211\210_custom.mid" differ
-diff --git a/LyreAutoPlayer/midi-change/index.json b/LyreAutoPlayer/midi-change/index.json
-index e0a8c05..a3f9d7b 100644
---- a/LyreAutoPlayer/midi-change/index.json
-+++ b/LyreAutoPlayer/midi-change/index.json
-@@ -5,7 +5,7 @@
-       "saved_path": "d:\\dw11\\piano\\lyreautoplayer\\midi-change\\city-of-stars-星光之城-爱乐之城-原神风物之诗琴谱-原琴谱_custom.mid",
-       "display_name": "City-of-Stars-星光之城-爱乐之城-原神风物之诗琴谱-原琴谱_custom",
-       "edit_style": "custom",
--      "last_modified": "2026-01-05T21:49:47.473680",
-+      "last_modified": "2026-01-05T21:51:32.631153",
-       "source_file_size": 5682,
-       "source_note_count": 626
-     },
-@@ -50,7 +50,7 @@
-       "saved_path": "d:\\dw11\\piano\\lyreautoplayer\\midi-change\\counting-stars-c调简单版_custom.mid",
-       "display_name": "Counting-Stars-C调简单版_custom",
-       "edit_style": "custom",
--      "last_modified": "2026-01-05T19:58:45.221526",
-+      "last_modified": "2026-01-06T02:47:48.842924",
-       "source_file_size": 5228,
-       "source_note_count": 573
-     },
-@@ -71,6 +71,33 @@
-       "last_modified": "2026-01-04T17:53:25.156000",
-       "source_file_size": 16227,
-       "source_note_count": 2410
-+    },
-+    {
-+      "source_path": "d:\\dw11\\piano\\lyreautoplayer\\midi\\绯想天-东方绯想天bgm.mid",
-+      "saved_path": "d:\\dw11\\piano\\lyreautoplayer\\midi-change\\绯想天-东方绯想天bgm_custom.mid",
-+      "display_name": "绯想天-东方绯想天BGM_custom",
-+      "edit_style": "custom",
-+      "last_modified": "2026-01-05T22:11:57.171074",
-+      "source_file_size": 18554,
-+      "source_note_count": 2047
-+    },
-+    {
-+      "source_path": "d:\\dw11\\piano\\lyreautoplayer\\midi\\one-last-kiss-宇多田光-原神风物之诗琴谱-原琴谱.mid",
-+      "saved_path": "d:\\dw11\\piano\\lyreautoplayer\\midi-change\\one-last-kiss-宇多田光-原神风物之诗琴谱-原琴谱_custom.mid",
-+      "display_name": "One-Last-Kiss-宇多田光-原神风物之诗琴谱-原琴谱_custom",
-+      "edit_style": "custom",
-+      "last_modified": "2026-01-05T22:25:12.128583",
-+      "source_file_size": 18491,
-+      "source_note_count": 2185
-+    },
-+    {
-+      "source_path": "d:\\dw11\\piano\\lyreautoplayer\\midi\\counting-stars-onerepublic.mid",
-+      "saved_path": "d:\\dw11\\piano\\lyreautoplayer\\midi-change\\counting-stars-onerepublic_custom.mid",
-+      "display_name": "Counting-Stars-OneRepublic_custom",
-+      "edit_style": "custom",
-+      "last_modified": "2026-01-06T03:11:37.051996",
-+      "source_file_size": 15587,
-+      "source_note_count": 1774
-     }
-   ]
- }
-\ No newline at end of file
-diff --git a/LyreAutoPlayer/player/config.py b/LyreAutoPlayer/player/config.py
-index d9f9c6f..14aa8b0 100644
---- a/LyreAutoPlayer/player/config.py
-+++ b/LyreAutoPlayer/player/config.py
-@@ -4,7 +4,7 @@ Player configuration dataclass.
- """
- 
- from dataclasses import dataclass, field
--from typing import Optional
-+from typing import List, Optional
- 
- from .errors import ErrorConfig
- from style_manager import EightBarStyle
-@@ -51,6 +51,7 @@ class PlayerConfig:
-     pause_every_bars: int = 0             # 自动暂停间隔 (0=禁用, 1/2/4/8)
-     auto_resume_countdown: int = 3        # 倒计时秒数
-     bar_duration_override: float = 0.0    # 覆盖小节时长 (秒), 0=自动计算
-+    bar_boundaries_sec: List[float] = field(default_factory=list)  # 可变小节边界时间列表
-     editor_bpm: int = 0                   # 编辑器 BPM, 0=使用 MIDI 原始值
-     start_at_time: float = 0.0            # 从指定时间开始播放 (秒)
-     skip_countdown: bool = False          # 跳过倒计时 (用于从上一小节恢复)
-diff --git a/LyreAutoPlayer/player/midi_parser.py b/LyreAutoPlayer/player/midi_parser.py
-index d49f459..942349c 100644
---- a/LyreAutoPlayer/player/midi_parser.py
-+++ b/LyreAutoPlayer/player/midi_parser.py
-@@ -29,7 +29,8 @@ def midi_to_events_with_duration(mid_path: str) -> List[NoteEvent]:
-     Returns:
-         List of NoteEvent sorted by time
-     """
--    mid = mido.MidiFile(mid_path)
-+    # clip=True: 容错模式，裁剪超范围数据字节到 0..127
-+    mid = mido.MidiFile(mid_path, clip=True)
-     tempo = 500000  # default 120 BPM
-     t = 0.0
- 
-diff --git a/LyreAutoPlayer/player/thread.py b/LyreAutoPlayer/player/thread.py
-index 466546a..f2bf337 100644
---- a/LyreAutoPlayer/player/thread.py
-+++ b/LyreAutoPlayer/player/thread.py
-@@ -99,6 +99,7 @@ class PlayerThread(QThread):
-         self._pause_start = 0.0
-         self._total_pause_time = 0.0
-         self._bar_duration = 2.0  # Default bar duration (120BPM 4/4)
-+        self._bar_boundaries_sec: list = []  # 可变小节边界时间列表 (秒)
-         self._current_bar = -1  # Current bar index
-         self._total_duration = 0.0  # Total playback duration (for progress)
-         self._last_progress_emit = 0.0  # Last time progress was emitted
-@@ -429,7 +430,7 @@ class PlayerThread(QThread):
-         beat_duration_for_filter = 0.5
-         if self.cfg.midi_path and os.path.isfile(self.cfg.midi_path):
-             try:
--                mid_obj = mido.MidiFile(self.cfg.midi_path)
-+                mid_obj = mido.MidiFile(self.cfg.midi_path, clip=True)
-                 bar_duration, beat_duration_for_filter = calculate_bar_and_beat_duration(mid_obj)
-                 self._bar_duration = bar_duration
-             except Exception:
-@@ -440,6 +441,11 @@ class PlayerThread(QThread):
-             self._bar_duration = self.cfg.bar_duration_override
-             self.log.emit(f"Using editor bar duration: {self._bar_duration:.3f}s")
- 
-+        # Use variable bar boundaries if provided (for stretched bars)
-+        if self.cfg.bar_boundaries_sec:
-+            self._bar_boundaries_sec = list(self.cfg.bar_boundaries_sec)
-+            self.log.emit(f"Using {len(self._bar_boundaries_sec)} variable bar boundaries")
-+
-         # 8-bar style setup
-         eight_bar = self.cfg.eight_bar_style
-         eight_bar_segments, segment_duration, beat_duration, warp_start = self._setup_eight_bar(eight_bar, speed)
-@@ -666,7 +672,35 @@ class PlayerThread(QThread):
-                     prev_release = release_time
- 
-         # Insert pause markers at bar boundaries (for pause-at-bar)
--        if self._bar_duration > 1e-9 and self.events:
-+        # 优先使用可变小节边界列表 (支持拉长/压缩的小节)
-+        if self._bar_boundaries_sec and self.events:
-+            # 使用预计算的小节边界时间
-+            for bar_idx, boundary_orig in enumerate(self._bar_boundaries_sec, start=1):
-+                if boundary_orig <= 0:
-+                    continue  # 跳过 0 时刻 (第 1 小节起点不需要暂停标记)
-+                boundary_time = boundary_orig / speed
-+                if eight_bar.enabled:
-+                    _, timing_mult, _, _ = self._get_section_multipliers(
-+                        boundary_time, eight_bar_segments, segment_duration
-+                    )
-+                    seg_start = int(boundary_time / segment_duration) * segment_duration if segment_duration > 1e-9 else 0.0
-+                    mapped_time = seg_start + (boundary_time - seg_start) * timing_mult
-+                    if use_warp:
-+                        mapped_time, _ = self._map_time_warp(
-+                            mapped_time, 1.0, eight_bar_segments, segment_duration, warp_start
-+                        )
-+                    elif use_beat_lock:
-+                        mapped_time, _ = self._map_time_beat_lock(
-+                            mapped_time, 1.0, eight_bar_segments, segment_duration, beat_duration
-+                        )
-+                    boundary_time = mapped_time
-+                pause_marker_time = max(0.0, boundary_time - 0.001)
-+                heapq.heappush(
-+                    event_queue,
-+                    KeyEvent(pause_marker_time, 0, "pause_marker", "", 0, bar_index=bar_idx)
-+                )
-+        elif self._bar_duration > 1e-9 and self.events:
-+            # 兜底: 使用固定小节时长计算边界
-             total_time = max(e.time + e.duration for e in self.events)
-             num_bars = int(total_time / self._bar_duration) + 1
-             for bar_idx in range(1, num_bars + 1):
-@@ -687,8 +721,7 @@ class PlayerThread(QThread):
-                             mapped_time, 1.0, eight_bar_segments, segment_duration, beat_duration
-                         )
-                     boundary_time = mapped_time
--                # Add small epsilon to ensure pause_marker is processed before events at exact boundary
--                pause_marker_time = max(0.0, boundary_time - 0.001)  # 1ms epsilon
-+                pause_marker_time = max(0.0, boundary_time - 0.001)
-                 heapq.heappush(
-                     event_queue,
-                     KeyEvent(pause_marker_time, 0, "pause_marker", "", 0, bar_index=bar_idx)
-@@ -710,7 +743,7 @@ class PlayerThread(QThread):
-         bar_duration = 2.0
-         if self.cfg.midi_path and os.path.isfile(self.cfg.midi_path):
-             try:
--                mid_obj = mido.MidiFile(self.cfg.midi_path)
-+                mid_obj = mido.MidiFile(self.cfg.midi_path, clip=True)
-                 bar_duration, beat_duration = calculate_bar_and_beat_duration(mid_obj)
-                 self.log.emit(f"8-Bar: bar_duration={bar_duration:.3f}s, beat_duration={beat_duration:.3f}s")
-             except Exception as e:
-diff --git a/LyreAutoPlayer/settings.json b/LyreAutoPlayer/settings.json
-index 2db0a3c..d378944 100644
---- a/LyreAutoPlayer/settings.json
-+++ b/LyreAutoPlayer/settings.json
-@@ -14,12 +14,12 @@
-   "countdown_sec": 2,
-   "keyboard_preset": "36-key",
-   "use_midi_duration": true,
--  "play_sound": false,
-+  "play_sound": true,
-   "velocity": 90,
-   "input_style": "mechanical",
-   "enable_diagnostics": false,
-   "soundfont_path": "C:\\soundfonts\\FluidR3_GM.sf2",
--  "last_midi_path": "D:/dw11/piano/LyreAutoPlayer/midi/Counting-Stars-C调简单版.mid",
-+  "last_midi_path": "D:/dw11/piano/LyreAutoPlayer/midi/绯想天-东方绯想天BGM.mid",
-   "input_manager": {},
-   "error_config": {
-     "enabled": false,
-diff --git a/LyreAutoPlayer/ui/editor/editor_window.py b/LyreAutoPlayer/ui/editor/editor_window.py
-index 4c7ae4c..3da5a93 100644
---- a/LyreAutoPlayer/ui/editor/editor_window.py
-+++ b/LyreAutoPlayer/ui/editor/editor_window.py
-@@ -568,7 +568,8 @@ class EditorWindow(QMainWindow):
-             source_path: 原始文件路径 (用于索引)。若为 None，则尝试从 index.json 反查
-         """
-         try:
--            self.midi_file = mido.MidiFile(path)
-+            # clip=True: 容错模式，将超范围数据字节裁剪到 0..127 (避免 "data byte must be in range" 错误)
-+            self.midi_file = mido.MidiFile(path, clip=True)
-             self.midi_path = path
- 
-             # 确定原始文件路径
-@@ -675,7 +676,7 @@ class EditorWindow(QMainWindow):
-             音符数量，失败时返回 0
-         """
-         try:
--            midi_file = mido.MidiFile(midi_path)
-+            midi_file = mido.MidiFile(midi_path, clip=True)
-             count = 0
-             for track in midi_file.tracks:
-                 for msg in track:
-@@ -1291,9 +1292,15 @@ class EditorWindow(QMainWindow):
-         track = mido.MidiTrack()
-         new_midi.tracks.append(track)
- 
--        # 收集所有事件（tempo + 音符）
-+        # 收集所有事件（time_signature + tempo + 音符）
-         events = []
- 
-+        # 添加 time_signature 事件（复用原始拍号，避免默认 4/4 覆盖）
-+        time_sig_events = getattr(self, '_time_sig_events_tick', [(0, 4, 4)])
-+        for abs_tick, numerator, denominator in time_sig_events:
-+            # (tick, type, numerator, denominator, 0)
-+            events.append((abs_tick, 'time_signature', numerator, denominator, 0))
-+
-         # 添加 tempo 事件
-         for abs_tick, tempo in tempo_events:
-             events.append((abs_tick, 'set_tempo', tempo, 0, 0))  # (tick, type, tempo, 0, 0)
-@@ -1323,15 +1330,17 @@ class EditorWindow(QMainWindow):
-             events.append((start_tick, 'note_on', note_pitch, velocity, channel))
-             events.append((end_tick, 'note_off', note_pitch, 0, channel))
- 
--        # 按时间排序：tempo 优先，然后 note_off 优先于 note_on
-+        # 按时间排序：time_signature 最先，tempo 次之，然后 note_off 优先于 note_on
-         def sort_key(e):
-             tick, msg_type = e[0], e[1]
--            if msg_type == 'set_tempo':
--                return (tick, 0)  # tempo 最先
-+            if msg_type == 'time_signature':
-+                return (tick, 0)  # time_signature 最先
-+            elif msg_type == 'set_tempo':
-+                return (tick, 1)  # tempo 次之
-             elif msg_type == 'note_off':
--                return (tick, 1)  # note_off 次之
-+                return (tick, 2)  # note_off 再次
-             else:
--                return (tick, 2)  # note_on 最后
-+                return (tick, 3)  # note_on 最后
- 
-         events.sort(key=sort_key)
- 
-@@ -1342,7 +1351,20 @@ class EditorWindow(QMainWindow):
-             msg_type = event[1]
-             delta = abs_tick - prev_tick
- 
--            if msg_type == 'set_tempo':
-+            if msg_type == 'time_signature':
-+                numerator = event[2]
-+                denominator = event[3]
-+                # mido time_signature: denominator 使用实际值 (4=四分音符, 8=八分音符)
-+                # mido 内部自动处理 MIDI 文件格式的指数转换
-+                track.append(mido.MetaMessage(
-+                    'time_signature',
-+                    numerator=numerator,
-+                    denominator=denominator,
-+                    clocks_per_click=24,
-+                    notated_32nd_notes_per_beat=8,
-+                    time=delta
-+                ))
-+            elif msg_type == 'set_tempo':
-                 tempo = event[2]
-                 track.append(mido.MetaMessage('set_tempo', tempo=tempo, time=delta))
-             else:
-@@ -2143,6 +2165,20 @@ class EditorWindow(QMainWindow):
-         beats_per_bar = numerator * (4.0 / denominator)
-         return 60.0 / bpm * beats_per_bar
- 
-+    def get_bar_boundaries(self) -> list:
-+        """获取小节边界时间列表 (秒)。
-+
-+        用于暂停标记同步可变小节时长。
-+
-+        Returns:
-+            [time_sec, ...] - 每个小节起点的时间 (秒)
-+        """
-+        if hasattr(self, 'timeline'):
-+            bar_times = self.timeline.get_bar_times()
-+            # bar_times 格式: [(bar_num, time_sec), ...]
-+            return [time_sec for _, time_sec in bar_times]
-+        return []
-+
-     def get_pause_bars(self) -> int:
-         """Get auto-pause interval (bars).
- 
-diff --git a/LyreAutoPlayer/ui/editor/timeline.py b/LyreAutoPlayer/ui/editor/timeline.py
-index 2e26526..e4de218 100644
---- a/LyreAutoPlayer/ui/editor/timeline.py
-+++ b/LyreAutoPlayer/ui/editor/timeline.py
-@@ -415,12 +415,13 @@ class TimelineWidget(QWidget):
-         bpm_y = int(row_bottom * 0.7)  # ~21 @ ROW_BAR=30
-         painter.drawText(4, bpm_y, bpm_text)
- 
--        # 检查是否使用可变小节时长
--        if self._bar_durations_sec and self._bar_times:
--            # 使用可变小节边界绘制
-+        # 优先使用 _bar_times（确保 timeline 与 piano_roll 节拍线对齐）
-+        # _bar_times 来源于 _rebuild_bar_times()，可能是可变时长或 tick 精确计算
-+        if self._bar_times:
-+            # 使用预计算的小节边界绘制（与 piano_roll 共享同一数据源）
-             self._draw_bar_row_variable(painter, start_time, end_time, font_bar, row_top, row_bottom)
-         else:
--            # 使用 tick 精确计算拍子和小节
-+            # 兜底：_bar_times 为空时实时计算（仅在初始化阶段或特殊情况）
-             self._draw_bar_row_fixed(painter, start_time, end_time, font_bar, row_top, row_bottom)
- 
-     def _draw_bar_row_variable(self, painter: QPainter, start_time: float, end_time: float,
-diff --git a/LyreAutoPlayer/ui/mixins/playback_mixin.py b/LyreAutoPlayer/ui/mixins/playback_mixin.py
-index 03925bd..d9bf7c2 100644
---- a/LyreAutoPlayer/ui/mixins/playback_mixin.py
-+++ b/LyreAutoPlayer/ui/mixins/playback_mixin.py
-@@ -44,6 +44,10 @@ class PlaybackMixin:
-             cfg.bar_duration_override = editor.get_bar_duration()
-             cfg.editor_bpm = editor.sp_bpm.value() if hasattr(editor, 'sp_bpm') else 0
- 
-+            # Pass variable bar boundaries for pause marker sync
-+            if hasattr(editor, 'get_bar_boundaries'):
-+                cfg.bar_boundaries_sec = editor.get_bar_boundaries()
-+
-             # Use editor's pause, octave, and input style settings
-             cfg.pause_every_bars = editor.get_pause_bars()
-             cfg.auto_resume_countdown = editor.get_auto_resume_countdown()
-diff --git a/analydocs/HANDOFF.md b/analydocs/HANDOFF.md
-index ee885ad..da180dd 100644
---- a/analydocs/HANDOFF.md
-+++ b/analydocs/HANDOFF.md
-@@ -1,22 +1,42 @@
--# Handoff - 2026-01-01 (Session 4)
-+# Handoff - 2026-01-05 (Session 14)
- 
- > **完整版（含调试细节）**: `.claude/private/HANDOFF.md`
- 
- ## TL;DR
- 
--1. **settings_manager.py 集成完成** - 将设置管理器集成到 main.py UI
--2. **预设系统上线** - 6 个内置预设可通过 UI 选择和应用
--3. **导入/导出功能** - 支持 JSON 格式设置文件导入导出
--4. **恢复默认功能** - 带确认对话框的重置功能
--5. **双语支持** - 添加 19 个中英文翻译键
--6. **验收通过** - 16/16 回归测试全部通过
-+Session 12-14 完成了可变小节时长系统及相关修复：
-+
-+1. **可变小节时长系统** - 支持拉伸/压缩单个小节的时长
-+2. **time_signature 保存修复** - 使用实际 denominator 值（移除错误的 denom_log 转换）
-+3. **timeline/piano_roll 对齐** - 统一两者的节拍线绘制数据源
-+4. **暂停点可变边界** - 暂停标记使用可变小节边界而非固定时长
-+5. **mido 容错读取** - 添加 `clip=True` 处理非法 MIDI 数据字节
-+6. **Stretch 输入框保值** - 点击"拉伸"后不再归零，保留用户输入
- 
- ## Verified Facts
- 
--- settings_manager 模块正常导入
--- 6 个内置预设: fast_precise, natural_flow, stable_compat, expressive_human, 21key_default, 36key_default
--- 回归测试 16/16 通过
--- 输入系统测试通过
-+- mido `MetaMessage('time_signature', denominator=4)` 存储实际值 4，非指数
-+- 所有 6 个修改文件语法检查通过 (tests.log)
-+- `bar_boundaries_sec` 数据链路完整：config → thread → 暂停标记插入
-+
-+## Evidence
-+
-+### tests.log 输出
-+```
-+=== 语法验证测试 ===
-+[PASS] config.py: bar_boundaries_sec 字段存在，类型=list
-+[PASS] thread.py: 导入成功
-+[PASS] midi_parser.py: 导入成功
-+[PASS] editor_window.py: 导入成功
-+[PASS] timeline.py: 导入成功
-+[PASS] playback_mixin.py: 导入成功
-+
-+=== mido time_signature 验证 ===
-+mido.MetaMessage(time_signature, denominator=4) -> 4
-+[PASS] mido 使用实际 denominator 值
-+
-+=== 全部通过 ===
-+```
- 
- ## Blockers
- 
-@@ -24,42 +44,81 @@
- 
- ## Next Steps
- 
--1. **运行主程序验证 UI**
-+1. **用户验证测试**
-    ```powershell
-    cd LyreAutoPlayer
-    .venv\Scripts\python.exe main.py
-    ```
- 
--2. **验证预设功能**
--   - 检查 Tab 1 顶部"设置预设"组
--   - 测试下拉框选择预设
--   - 点击"应用"按钮验证设置变化
-+2. **验证 time_signature 保存**
-+   - 打开编辑器，拉伸小节，保存
-+   - 重新加载，确认小节线密度正确
- 
--3. **游戏内实际测试**
--   - 测试不同预设的演奏效果
-+3. **验证 mido 容错**
-+   - 打开"江南"等有非法数据字节的 MIDI
-+   - 确认无 "data byte must be in range 0..127" 报错
- 
- ## Acceptance Status
- 
--| 验收项 | 状态 |
--|--------|------|
--| settings_manager 导入 | PASS |
--| 预设下拉框显示 | PASS |
--| 导入/导出功能 | PASS |
--| 恢复默认功能 | PASS |
--| 双语翻译 | PASS |
--| 回归测试 | PASS (16/16) |
--| 输入系统测试 | PASS |
--
--## Files Touched
--
--### 修改
--- `LyreAutoPlayer/main.py` - 集成 settings_manager UI
--- `LyreAutoPlayer/test_regression.py` - 修复后端检查
-+| 验收项 | 状态 | 证据 |
-+|--------|------|------|
-+| time_signature 保存 | PASS | denom_log 已移除，使用实际值 |
-+| timeline/piano_roll 对齐 | PASS | 语法验证 |
-+| 暂停点可变边界 | PASS | 语法验证 + 链路完整 |
-+| mido 容错读取 | PASS | 5 处 clip=True |
-+| Stretch 输入框保值 | PASS | commit 2789fbe |
-+| Undo/Redo | PASS | Session 12 已实现 |
-+| 用户功能验证 | 待测试 | - |
-+
-+## Files Touched (含行号)
-+
-+### Fix 1: time_signature 保存 (移除 denom_log)
-+- [editor_window.py:1354-1366](LyreAutoPlayer/ui/editor/editor_window.py#L1354-L1366)
-+  ```python
-+  # 修改前: denominator=denom_log (错误，转为指数)
-+  # 修改后: denominator=denominator (正确，mido 使用实际值)
-+  ```
-+
-+### Fix 2: timeline/piano_roll 对齐
-+- [timeline.py:534](LyreAutoPlayer/ui/editor/timeline.py#L534)
-+  ```python
-+  if self._bar_times:  # 优先使用预计算的小节边界
-+  ```
-+
-+### Fix 3: Stretch 输入框保值
-+- [editor_window.py:1027-1028](LyreAutoPlayer/ui/editor/editor_window.py#L1027-L1028)
-+  ```python
-+  # 注: 不再重置 spinbox，保留最近输入值供用户连续调整
-+  # self.spin_bar_duration_delta.setValue(0)
-+  ```
-+
-+### Fix 4: bar_boundaries_sec 传递链路
-+1. **定义**: [config.py:54](LyreAutoPlayer/player/config.py#L54)
-+   ```python
-+   bar_boundaries_sec: List[float] = field(default_factory=list)
-+   ```
-+2. **传入**: [playback_mixin.py:49](LyreAutoPlayer/ui/mixins/playback_mixin.py#L49)
-+   ```python
-+   cfg.bar_boundaries_sec = editor.get_bar_boundaries()
-+   ```
-+3. **获取**: [editor_window.py:2168](LyreAutoPlayer/ui/editor/editor_window.py#L2168)
-+   ```python
-+   def get_bar_boundaries(self) -> list:
-+   ```
-+4. **使用**: [thread.py:102](LyreAutoPlayer/player/thread.py#L102), [445-447](LyreAutoPlayer/player/thread.py#L445-L447), [676-678](LyreAutoPlayer/player/thread.py#L676-L678)
-+   ```python
-+   self._bar_boundaries_sec: list = []
-+   if self.cfg.bar_boundaries_sec:
-+       self._bar_boundaries_sec = list(self.cfg.bar_boundaries_sec)
-+   ```
- 
--### 新增
--- `.claude/private/HANDOFF.md`
--- `.claude/private/handoff-archive.md`
--- `analydocs/handoff-archive.md`
-+### Fix 5: mido 容错读取 (clip=True)
-+- [editor_window.py:572](LyreAutoPlayer/ui/editor/editor_window.py#L572)
-+- [editor_window.py:679](LyreAutoPlayer/ui/editor/editor_window.py#L679)
-+- [midi_parser.py:33](LyreAutoPlayer/player/midi_parser.py#L33)
-+- [thread.py:433](LyreAutoPlayer/player/thread.py#L433)
-+- [thread.py:746](LyreAutoPlayer/player/thread.py#L746)
- 
- ---
--*生成时间: 2026-01-01*
-+*生成时间: 2026-01-05*
-+*验证脚本: LyreAutoPlayer/tests.log*
-diff --git a/ops/ai/state/STATE.md b/ops/ai/state/STATE.md
-index e2efdc2..967a162 100644
---- a/ops/ai/state/STATE.md
-+++ b/ops/ai/state/STATE.md
-@@ -2,9 +2,9 @@
- 
- ## Latest Task
- - TASK_ID: 20260103-midi-editor-pipeline
--- Status: IN_PROGRESS (Session 13 - BPM/Tempo Preservation Fixes)
-+- Status: PHASE DONE → NEW PHASE PENDING (Key Injection Performance)
- - Pointer: ops/ai/tasks/20260103-midi-editor-pipeline
--- Latest Commit: `9b7a351` (pending: Session 13 changes)
-+- Latest Commit: `2789fbe` (pending: Session 13-14 changes)
- 
- ## Previous Task
- - TASK_ID: 20260102-2138-main-mixin-refactor
-@@ -12,9 +12,10 @@
- - Pointer: ops/ai/tasks/20260102-2138-main-mixin-refactor
- 
- ## Current Focus
-+- Session 14: time_signature denominator fix (VERIFIED 6/6 PASSED)
-+- NEW PHASE: Key injection performance, KeyList reorder, preview sound unify
- - Session 13: BPM/tempo preservation fixes (审计发现的 6 个问题)
- - Session 12: Variable bar length system (可变小节时长)
--- Session 11: Bar duration adjustment bug fixes (6 issues)
- 
- ## Completed Summary (MIDI Editor)
- - **Phase 1 钢琴卷帘骨架完成**: 6 个新文件 (~745 行)
-@@ -63,7 +64,9 @@
- 2. Phase 3-4: 高级编辑 + 超音域处理预览（如需继续）
- 
- ## Recent Completions
--- Variable Bar Length System (Session 12, 2026-01-05) - **Committed: 62f4743**
-+- **time_signature denominator fix (Session 14, 2026-01-06) - VERIFIED 6/6**
-+- Timeline/PianoRoll alignment fix (Session 13-14) - Committed: 2789fbe
-+- Variable Bar Length System (Session 12, 2026-01-05) - Committed: 62f4743
- - Bar Duration Bug Fixes (Session 11, 2026-01-05) - Committed: bd39a79
- - Bug Fixes & New Features (Session 10, 2026-01-05) - Committed: 7b73a5d
- - UI Fixes & Auto-scroll (Session 9, 2026-01-05) - Committed: 7713727
-@@ -89,10 +92,11 @@
- ---
- 
- ## Next Actions
--1. **验收测试**: 拉长小节→保存→重载，确认小节刻度保持
--2. **验收测试**: 播放自动翻页时 KeyList 同步
--3. **提交**: 审计通过后 git commit
--4. Phase 3-4: 高级编辑 + 超音域处理预览（如需继续）
-+1. **Decision**: Commit Session 13-14 changes before starting new phase?
-+2. **New Phase Step 1**: Reproduce key injection issue with `midi/Counting-Stars-OneRepublic.mid` bar ~17-18
-+3. **New Phase Step 2**: Add lag instrumentation in PlayerThread
-+4. **New Phase Step 3**: Batch SendInput for same-timestamp events
-+5. **New Phase Step 4**: Isolate FluidSynth audio from critical key injection path
- 
- ---
--*Last Updated: 2026-01-05 (Session 13 - BPM/Tempo Preservation Fixes, IN_PROGRESS)*
-+*Last Updated: 2026-01-06 (Session 14 - time_signature fix VERIFIED, NEW PHASE PENDING)*
-diff --git a/ops/ai/tasks/20260103-midi-editor-pipeline/evidence/context_pack.md b/ops/ai/tasks/20260103-midi-editor-pipeline/evidence/context_pack.md
-index 4f13141..3fd3d56 100644
---- a/ops/ai/tasks/20260103-midi-editor-pipeline/evidence/context_pack.md
-+++ b/ops/ai/tasks/20260103-midi-editor-pipeline/evidence/context_pack.md
-@@ -2,9 +2,52 @@
- 
- ## Task
- - ID: 20260103-midi-editor-pipeline
--- Status: DONE (Session 13 - BPM/Tempo Preservation Fixes)
--- Last Updated: 2026-01-05
--- Previous Commit: `9b7a351`
-+- Status: PHASE DONE → NEW PHASE DEFINED
-+- Last Updated: 2026-01-06
-+- Latest Commit: `2789fbe`
-+
-+---
-+
-+## Session 14 Summary (2026-01-06)
-+**time_signature denominator fix - VERIFIED 6/6 PASSED**
-+
-+### Key Fix
-+- **Problem**: Bar line density doubled after save/reload
-+- **Root Cause**: Code used log2 conversion (`denom_log`) but mido expects actual values
-+- **Fix**: Remove denom_log conversion, use `denominator=denominator` directly
-+
-+### Verification Results
-+| Step | Component | Status |
-+|------|-----------|--------|
-+| 1/6 | editor_window.py:1357-1362 | OK - denominator uses actual value |
-+| 2/6 | playback_mixin.py:48-49 | OK - bar_boundaries_sec propagation |
-+| 3/6 | config.py:54 | OK - bar_boundaries_sec field |
-+| 4/6 | midi_parser.py:32-33 | OK - clip=True |
-+| 5/6 | thread.py:102,433,445-447,676,678,746 | OK - bar_boundaries_sec + clip=True |
-+| 6/6 | tests.log | OK - 6/6 imports, mido denominator=4→4 |
-+
-+---
-+
-+## NEW PHASE: Key Injection Performance (Defined in plan.md)
-+
-+### Goals
-+1. Fix missed key injection under dense notes/chords (events pile up with play_sound=True)
-+2. Reorder KeyList (36-key) to high→low pitch
-+3. Unify Editor Play vs Main Start preview sound
-+
-+### Reproduction
-+- MIDI: `midi/Counting-Stars-OneRepublic.mid`
-+- Section: bar ~17-18 / ~0:34s
-+
-+### Target Files
-+| File | Change |
-+|------|--------|
-+| `player/thread.py` | Lag instrumentation, batch SendInput, decouple synth |
-+| `input_manager.py` | Optional batch SendInput for chords |
-+| `ui/editor/key_list_widget.py` | Sort 36-key rows by pitch descending |
-+| `ui/editor/editor_window.py` | Align preview synth with main playback |
-+
-+---
- 
- ## Session 13 Summary (2026-01-05)
- BPM/tempo preservation and scroll sync fixes based on audit reports.
-diff --git a/ops/ai/tasks/20260103-midi-editor-pipeline/evidence/diff.patch b/ops/ai/tasks/20260103-midi-editor-pipeline/evidence/diff.patch
-index d49f3f6..25916d2 100644
---- a/ops/ai/tasks/20260103-midi-editor-pipeline/evidence/diff.patch
-+++ b/ops/ai/tasks/20260103-midi-editor-pipeline/evidence/diff.patch
-@@ -1,178 +0,0 @@
--diff --git a/LyreAutoPlayer/player/thread.py b/LyreAutoPlayer/player/thread.py
--index 6c4f743..466546a 100644
----- a/LyreAutoPlayer/player/thread.py
--+++ b/LyreAutoPlayer/player/thread.py
--@@ -265,7 +265,7 @@ class PlayerThread(QThread):
--                 self.log.emit("IME disabled for target window")
-- 
--         # Build event queue
---        event_queue, notes_scheduled, notes_dropped = self._build_event_queue(
--+        event_queue, notes_scheduled, notes_dropped, notes_dropped_accidental, notes_dropped_octave_conflict = self._build_event_queue(
--             note_to_key, avail_notes
--         )
-- 
--@@ -292,7 +292,13 @@ class PlayerThread(QThread):
--             self._total_duration = 0.0
-- 
--         if notes_dropped > 0:
---            self.log.emit(f"Dropped {notes_dropped} out-of-range notes")
--+            detail_parts = []
--+            if notes_dropped_accidental > 0:
--+                detail_parts.append(f"accidental/black-key={notes_dropped_accidental}")
--+            if notes_dropped_octave_conflict > 0:
--+                detail_parts.append(f"octave-conflict={notes_dropped_octave_conflict}")
--+            detail = f" ({', '.join(detail_parts)})" if detail_parts else ""
--+            self.log.emit(f"Dropped {notes_dropped} notes{detail}. Try 36-key or accidental_policy=lower/upper")
-- 
--         # Main playback loop
--         pressed_keys: Dict[str, int] = {}
--@@ -315,7 +321,11 @@ class PlayerThread(QThread):
--         # Final statistics
--         total = notes_scheduled + notes_dropped
--         if total > 0:
---            self.log.emit(f"Stats: played={notes_scheduled}, dropped={notes_dropped} ({100*notes_dropped//total}% dropped)")
--+            drop_pct = 100 * notes_dropped // total
--+            if notes_dropped > 0:
--+                self.log.emit(f"Stats: played={notes_scheduled}, dropped={notes_dropped} ({drop_pct}%) [accidental={notes_dropped_accidental}, octave-conflict={notes_dropped_octave_conflict}]")
--+            else:
--+                self.log.emit(f"Stats: played={notes_scheduled}, dropped=0")
-- 
--         if errors_applied > 0:
--             self.log.emit(f"Errors simulated: {errors_applied}")
--@@ -412,6 +422,8 @@ class PlayerThread(QThread):
-- 
--         notes_scheduled = 0
--         notes_dropped = 0
--+        notes_dropped_accidental = 0  # 黑键/无法映射到布局
--+        notes_dropped_octave_conflict = 0  # 八度冲突
-- 
--         # Calculate bar duration
--         beat_duration_for_filter = 0.5
--@@ -499,16 +511,19 @@ class PlayerThread(QThread):
--                             higher = beat_highest.get(beat_idx)
--                             if higher is not None and higher > note:
--                                 notes_dropped += 1
--+                                notes_dropped_octave_conflict += 1
--                                 continue
--                         else:
--                             lower = beat_lowest.get(beat_idx)
--                             if lower is not None and lower < note:
--                                 notes_dropped += 1
--+                                notes_dropped_octave_conflict += 1
--                                 continue
-- 
--             q = quantize_note(note, avail_notes, self.cfg.accidental_policy, oct_min, oct_max)
--             if q is None:
--                 notes_dropped += 1
--+                notes_dropped_accidental += 1
--                 continue
-- 
--             key = note_to_key[q]
--@@ -679,7 +694,7 @@ class PlayerThread(QThread):
--                     KeyEvent(pause_marker_time, 0, "pause_marker", "", 0, bar_index=bar_idx)
--                 )
-- 
---        return event_queue, notes_scheduled, notes_dropped
--+        return event_queue, notes_scheduled, notes_dropped, notes_dropped_accidental, notes_dropped_octave_conflict
-- 
--     def _setup_eight_bar(self, eight_bar, speed: float):
--         """Setup 8-bar style variation parameters."""
--diff --git a/LyreAutoPlayer/ui/editor/editor_window.py b/LyreAutoPlayer/ui/editor/editor_window.py
--index f34661b..40deeb5 100644
----- a/LyreAutoPlayer/ui/editor/editor_window.py
--+++ b/LyreAutoPlayer/ui/editor/editor_window.py
--@@ -583,6 +583,10 @@ class EditorWindow(QMainWindow):
-- 
--             self.piano_roll.load_midi(self.midi_file)
-- 
--+            # 清空可变小节数据，避免跨曲污染 BPM/网格/导出
--+            self.timeline.set_bar_durations([])
--+            self.piano_roll.set_bar_times([])
--+
--             # 解析 tempo 和 time signature 传递给时间轴
--             tempo_events, time_sig_events = self._extract_tempo_and_time_sig()
--             self.timeline.set_tempo_info(
--@@ -591,8 +595,9 @@ class EditorWindow(QMainWindow):
--                 time_sig_events
--             )
-- 
---            # 缓存 tempo 信息，供 BPM 变更时重建 timeline
--+            # 缓存 tempo 信息，供 BPM 变更时重建 timeline 和保存时复用
--             self._ticks_per_beat = self.midi_file.ticks_per_beat
--+            self._tempo_events_tick = tempo_events  # 原始 tempo 事件，用于无改动时复用
--             self._time_sig_events_tick = time_sig_events
-- 
--             # 更新时间轴
--@@ -619,8 +624,10 @@ class EditorWindow(QMainWindow):
--             self.sp_octave_shift.setValue(0)
--             self.sp_octave_shift.blockSignals(False)
-- 
---            # 同步时间轴为单一 BPM，确保与钢琴卷帘小节线对齐
---            self._sync_timeline_tempo(midi_bpm)
--+            # 仅当原始 MIDI 只有单一 tempo 时才同步为单一 BPM
--+            # 多段 tempo (可变小节时长) 已在 set_tempo_info() 中处理，不覆盖
--+            if len(tempo_events) <= 1:
--+                self._sync_timeline_tempo(midi_bpm)
-- 
--             # 更新量化网格（使用新 MIDI 的 BPM）
--             self._on_quantize_changed(self.cmb_quantize.currentText())
--@@ -1202,7 +1209,7 @@ class EditorWindow(QMainWindow):
--         当前为简化单轨输出（多轨合并为单轨）。
-- 
--         支持可变小节时长：如果 timeline 有 bar_durations，则为每个不同时长的小节
---        生成对应的 tempo 事件。公式：microseconds_per_beat = bar_duration_sec / beats_per_bar * 1_000_000
--+        生成对应的 tempo 事件。公式: seconds_per_quarter = bar_duration_sec / beats_per_bar * 4 / beat_unit (微秒/四分音符)
-- 
--         WARNING: 此方法会丢失原始 MIDI 的以下信息：
--         - 原始 tempo map (多个速度变化事件) → 替换为单一用户 BPM 或可变小节时长
--@@ -1258,6 +1265,9 @@ class EditorWindow(QMainWindow):
--                 user_bpm = self.sp_bpm.value()
--                 user_tempo = mido.bpm2tempo(user_bpm)
--                 tempo_events = [(0, user_tempo)]
--+        elif self.sp_bpm.value() == getattr(self, '_base_bpm', 0) and hasattr(self, '_tempo_events_tick'):
--+            # BPM 未改动且有原始 tempo 事件，复用原始 tempo map 避免无意改速
--+            tempo_events = list(self._tempo_events_tick)
--         else:
--             # 使用用户设定的 BPM (来自工具栏 spinbox) 而非原始 MIDI tempo
--             user_bpm = self.sp_bpm.value()
--@@ -1713,6 +1723,9 @@ class EditorWindow(QMainWindow):
-- 
--         # 更新按键列表进度
--         if self.chk_key_list.isChecked():
--+            # 显式同步滚动值到 key_list (修复播放翻页不同步)
--+            scroll_value = self.piano_roll.horizontalScrollBar().value()
--+            self.key_list.set_scroll_offset(scroll_value)
--             self.key_list.update_playback_time(self.playback_time)
-- 
--     def _update_time_label(self):
--diff --git a/LyreAutoPlayer/ui/editor/key_list_widget.py b/LyreAutoPlayer/ui/editor/key_list_widget.py
--index 46ad840..e1966bb 100644
----- a/LyreAutoPlayer/ui/editor/key_list_widget.py
--+++ b/LyreAutoPlayer/ui/editor/key_list_widget.py
--@@ -129,7 +129,7 @@ class KeyProgressWidget(QGraphicsView):
-- 
--         # 视图设置
--         self.setHorizontalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAlwaysOff)  # 只跟随 piano_roll
---        self.setVerticalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAsNeeded)
--+        self.setVerticalScrollBarPolicy(Qt.ScrollBarPolicy.ScrollBarAlwaysOn)  # 保持与 piano_roll 视口宽度一致
--         self.setRenderHint(QPainter.RenderHint.Antialiasing, False)
--         self.setAlignment(Qt.AlignmentFlag.AlignLeft | Qt.AlignmentFlag.AlignTop)
-- 
--@@ -150,7 +150,6 @@ class KeyProgressWidget(QGraphicsView):
--             }
--             QScrollBar:vertical {
--                 background-color: #2D2D2D;
---                width: 12px;
--             }
--             QScrollBar::handle:vertical {
--                 background-color: #555;
--@@ -163,9 +162,7 @@ class KeyProgressWidget(QGraphicsView):
-- 
--     def set_scroll_offset(self, offset: int):
--         """设置水平滚动位置（从 PianoRollWidget 同步）"""
---        self.horizontalScrollBar().blockSignals(True)
--         self.horizontalScrollBar().setValue(offset)
---        self.horizontalScrollBar().blockSignals(False)
-- 
--     def set_layout(self, layout_name: str):
--         """设置键盘布局"""
-diff --git a/ops/ai/tasks/20260103-midi-editor-pipeline/handoff.md b/ops/ai/tasks/20260103-midi-editor-pipeline/handoff.md
-index ea8d798..f794bcf 100644
---- a/ops/ai/tasks/20260103-midi-editor-pipeline/handoff.md
-+++ b/ops/ai/tasks/20260103-midi-editor-pipeline/handoff.md
-@@ -1,5 +1,59 @@
- # Handoff - MIDI Editor Pipeline
- 
-+## Session 14 (2026-01-06) - time_signature denominator fix
-+
-+### Status: PHASE DONE → NEW PHASE DEFINED
-+
-+### Completed Work
-+**time_signature denominator fix - VERIFIED 6/6 PASSED**
-+
-+| Issue | Root Cause | Fix |
-+|-------|------------|-----|
-+| Bar line density doubled after save/reload | Code used log2 conversion (denom_log) | Remove denom_log, use actual denominator value |
-+| mido semantics misunderstanding | Assumed MIDI file format exponent | mido abstracts exponent internally |
-+
-+### Evidence Index
-+
-+| File | Path | Purpose |
-+|------|------|---------|
-+| context_pack.md | evidence/context_pack.md | 低 token 摘要 + 新阶段目标 |
-+| diff.patch | evidence/diff.patch | 当前改动 (336 行) |
-+| execute.log | evidence/execute.log | 执行日志 + 6/6 验证结果 |
-+| tests.log | LyreAutoPlayer/tests.log | 语法验证 + mido semantics |
-+
-+### Verification Results
-+```
-+=== PLANNER-EXECUTE LOG ===
-+Steps: 6
-+Status: ALL PASSED
-+- editor_window.py:1357-1362: denominator uses actual value
-+- playback_mixin.py:48-49: bar_boundaries_sec propagation
-+- config.py:54: bar_boundaries_sec field
-+- midi_parser.py:32-33: clip=True
-+- thread.py: bar_boundaries_sec + clip=True (5 sites)
-+- tests.log: 6/6 imports, mido denominator=4→4
-+```
-+
-+---
-+
-+## NEW PHASE: Key Injection Performance
-+
-+### Goals (from plan.md)
-+1. Fix missed key injection under dense notes/chords (events pile up with play_sound=True)
-+2. Reorder KeyList (36-key) to high→low pitch
-+3. Unify Editor Play vs Main Start preview sound
-+
-+### Reproduction
-+- MIDI: `midi/Counting-Stars-OneRepublic.mid`
-+- Section: bar ~17-18 / ~0:34s
-+
-+### Decision Points for Planner
-+1. **Commit first?** Current changes (time_signature fix) are verified - commit before new phase?
-+2. **Priority order?** Key injection fix vs KeyList reorder vs preview sound?
-+3. **Synth isolation?** Separate thread vs queue vs degradation under overload?
-+
-+---
-+
- ## Session 13 (2026-01-05) - BPM/Tempo Preservation Fixes
- 
- ### Goals
-diff --git a/ops/ai/tasks/20260103-midi-editor-pipeline/plan.md b/ops/ai/tasks/20260103-midi-editor-pipeline/plan.md
-index 33f7c8c..1d4f01b 100644
---- a/ops/ai/tasks/20260103-midi-editor-pipeline/plan.md
-+++ b/ops/ai/tasks/20260103-midi-editor-pipeline/plan.md
-@@ -1,22 +1,40 @@
--# Plan
-+# Plan: 20260103-midi-editor-pipeline
- 
--## Steps
--1. 手动验收 Ctrl+拖拽选择小节：确认仅显示黄色竖线与小节高亮，未出现蓝色选区矩形。
--   - Acceptance: 选区拖拽时蓝色矩形不出现；黄色边界线与小节高亮正常。
--2. 手动验收非连续小节拉伸：选择 bar 1-2 与 bar 5-6，执行拉伸/压缩。
--   - Acceptance: 每个区间独立拉伸；bar 3-4 平移仅受前置区间影响；bar 7+ 受累计平移影响。
--3. 手动验收“未选中小节”提示：未选中小节时点击拉伸按钮。
--   - Acceptance: 弹窗显示中文提示，文案来自 i18n（`no_bars_selected_*`）。
--4. 若需进入 Phase 3-4（高级编辑 + 超音域处理预览），先明确需求范围与验收标准。
--   - Acceptance: 需求范围与验收标准明确后再规划后续实现。
-+## Goal/Scope
-+完成 Session 13 的 BPM/tempo 保留修复验收，确保保存/重载与播放滚动一致性，不引入新的编辑回归。
- 
--## Commands
--- （无）
-+## Constraints/Assumptions
-+- 保持 PyQt6 + mido 现有流程不变；模块独立，不影响现有播放逻辑。
-+- time_signature denominator 使用实际值（4=四分音符），避免指数化导致小节线密度翻倍。
-+- 已有修复在本次计划中以验证为主，失败才进入修复。
- 
--## Evidence Checklist
--- 手动验收记录（步骤 + 结果）。
--- 异常截图或日志（如有）。
-+## 完成摘要
-+| 任务 | 状态 | 详情 |
-+| --- | --- | --- |
-+| mido denominator 验证 | ✅ | 实测 mido 使用实际值，非指数 |
-+| 修复 denom_log 错误 | ✅ | `ui/editor/editor_window.py:1354-1366` |
-+| 语法验证证据 | ✅ | tests.log 6/6 模块导入成功 |
-+| Stretch 归零证据 | ✅ | commit 2789fbe，line 1027-1028 |
-+| bar_boundaries_sec 链路 | ✅ | config:54 → playback_mixin:49 → editor:2168 → thread:102,445,676 |
-+| clip=True 行号 | ✅ | editor:572,679 / midi_parser:33 / thread:433,746 |
-+| 关键修复 | ✅ | mido MetaMessage('time_signature') 期望实际 denominator 值（4=四分音符），原代码错误地转为指数（4→2），导致保存后重载小节线密度翻倍 |
- 
--## Stop Conditions
--- 任一手动验收不符合预期。
--- Phase 3-4 需求范围或验收标准未明确。
-+## 实施计划
-+1. 复核完成摘要与修复点，确认无重复检查项。
-+2. 执行验收测试：拉长小节→保存→重载；播放自动翻页观察 KeyList 同步；播放含黑键记录日志分类。
-+3. 若验收失败，定位到 `ui/editor/editor_window.py`、`ui/editor/key_list_widget.py`、`player/thread.py` 或 `midi_parser` 修复并回归。
-+4. 验收通过后补齐测试记录并提交。
-+
-+## Acceptance Checklist
-+- [ ] 拉长小节→保存→重载，确认小节刻度保持
-+- [ ] 播放自动翻页时 KeyList 与 PianoRoll 同步
-+- [ ] 黑键/超音域丢弃日志包含分类（accidental/black-key 或 octave-conflict）
-+- [x] time_signature denominator 保持实际值，重载后小节线密度不翻倍
-+- [x] 基础导入验证记录（tests.log 6/6 模块导入成功）
-+
-+## Risks/Dependencies
-+- 保存/重载路径涉及 tempo map 与 time_signature 写回，需注意与 mido 兼容性
-+- 验收失败可能需要跨 `editor_window.py` 与 `thread.py` 协同调整
-+
-+---
-+*Generated: 2026-01-06 01:10*
diff --git a/ops/ai/tasks/20260103-midi-editor-pipeline/handoff.md b/ops/ai/tasks/20260103-midi-editor-pipeline/handoff.md
index 425d25f..1397810 100644
--- a/ops/ai/tasks/20260103-midi-editor-pipeline/handoff.md
+++ b/ops/ai/tasks/20260103-midi-editor-pipeline/handoff.md
@@ -1,8 +1,50 @@
 # Handoff - MIDI Editor Pipeline
 
+## Session 16 (2026-01-06) - Batch SendInput press_many
+
+### Status: DRAFT - Pending Planner Decision
+
+### Evidence Index
+
+| File | Path | Purpose |
+|------|------|---------|
+| context_pack.md | evidence/context_pack.md | 低 token 摘要 + 决策点 |
+| diff.patch | evidence/diff.patch | 当前未提交改动 (1310 行) |
+| execute.log | evidence/execute.log | 执行日志 Session 13-16 |
+| plan.md | .claude/private/plan.md | 用户提供的新阶段目标 |
+
+### Uncommitted Changes (Session 16)
+
+| File | Lines | Change |
+|------|-------|--------|
+| `input_manager.py` | +116 | `press_many()` batch SendInput method |
+| `thread.py` | +10 | `pending_presses[]` + `press_many()` call |
+
+### Decision Required for Planner
+
+User reported: **batch press worsened dense sections** (from plan.md)
+
+Options:
+1. **Rollback** press_many, keep only deferred synth (Session 15)
+2. **Tune** chord-lock delay / min_press_interval_ms
+3. **Add** late-drop policy for overloaded batches
+4. **Document** all timing-affecting configs first
+
+### Key Timing Configs to Document (from plan.md)
+
+| Config | File | Effect |
+|--------|------|--------|
+| style/humanization | ? | timing_offset/stagger/duration_variation |
+| debounce | input_manager.py | min_press_interval_ms |
+| min_hold | ? | duration flooring |
+| chord-lock | ? | delay between chord notes |
+| pause markers | thread.py | auto-pause every N bars |
+
+---
+
 ## Session 15 (2026-01-06) - Key Injection Performance
 
-### Status: PHASE DONE → PENDING COMMIT
+### Status: COMMITTED (6b18283)
 
 ### Completed Work
 **Key Injection Performance Optimization - 7/7 COMPLETED**
